# Session 2025-11-23: Recursive.eco Feature Implementation

> Comprehensive implementation plan for Recursive Creator fixes + Recursive Landing enhancements + Local playlist import

# Recommendation: Start with Recursive-Landing

  Reasoning:
  - üéØ Thanksgiving deadline - landing features are what you need for family
  playlists
  - ‚úÖ Quick win first - CSV export (30-45 min) gives immediate value
  - üîÑ Then tackle harder ones - transparent layer & calendar while I have context       
  - ‚è∞ Creator fixes can wait - they're quality-of-life improvements, not launch
  blockers

  Proposed Flow:
  1. Phase 2.2 - CSV export (EASIEST, immediate win)
  2. Phase 2.1 - Transparent layer (safety feature)
  3. Phase 2.3 - Calendar .ics (family planning)
  4. Phase 3 - Local import (bonus UX)
  5. Phase 1 - Creator fixes (post-Thanksgiving)

**Date:** 2025-11-23
**Projects:** recursive-creator, recursive-landing
**Goal:** Launch-ready features for Thanksgiving family playlists

---

## Overview

Today we're implementing interconnected features across both projects:
1. **Recursive Creator** - Fix import append behavior + improve license wording
2. **Recursive Landing** - Child safety features + calendar export + email collection
3. **Local Playlist Import** - Anonymous YouTube playlist import with localStorage

---

## Project 1: Recursive Creator Fixes

### Task 1.1: Fix Import Append Behavior ‚è≥
**Priority:** HIGH
**Time Estimate:** 30-60 min
**File:** `recursive-creator/app/dashboard/sequences/new/page.tsx`

**Problem:** When importing YouTube playlist or Drive folder, it **replaces** existing links instead of **appending** to the end.

**Current Behavior:**
```javascript
// Likely something like:
setItems(newItems); // ‚ùå REPLACES all items
```

**Desired Behavior:**
```javascript
// Should append:
setItems([...items, ...newItems]); // ‚úÖ ADDS to existing items
```

**Implementation Steps:**
1. Find the import handlers:
   - `handleImportPlaylist` (YouTube playlist import)
   - `handleImportFolder` (Drive folder import)
2. Change from `setItems(newItems)` to `setItems([...items, ...newItems])`
3. Update position numbers for new items (continue from last position)
4. Test with existing sequence + import

**Success Criteria:**
- [ ] Import YouTube playlist with existing items ‚Üí new videos added to end
- [ ] Import Drive folder with existing items ‚Üí new images added to end
- [ ] Position numbers increment correctly
- [ ] No duplicate items

---

### Task 1.2: Improve License Note Wording ‚è≥
**Priority:** MEDIUM
**Time Estimate:** 10-15 min
**File:** `recursive-creator/app/dashboard/sequences/new/page.tsx`

**Current Wording:** (Need to check existing license checkbox)

**Proposed Wording:**
```tsx
<label className="flex items-start gap-3 cursor-pointer">
  <input
    type="checkbox"
    checked={licenseAgreed}
    onChange={(e) => setLicenseAgreed(e.target.checked)}
    className="mt-1 w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
  />
  <span className="text-sm text-gray-800">
    I confirm that all content <strong>not coming from YouTube</strong> or
    specifically attributed under a license in the image itself can be
    published under <a
      href="https://creativecommons.org/licenses/by-sa/4.0/"
      target="_blank"
      className="text-purple-600 underline"
    >CC BY-SA 4.0 license</a>.
    Without direct attribution to YouTube or other license, this content
    will be assumed to be published under Creative Commons.
  </span>
</label>
```

**Key Changes:**
- ‚úÖ Clarifies "content NOT from YouTube" is under CC BY-SA
- ‚úÖ Mentions "specifically attributed" content exceptions
- ‚úÖ States assumption: no attribution = CC BY-SA
- ‚úÖ More conversational tone

**Success Criteria:**
- [ ] Checkbox text updated
- [ ] Link to CC BY-SA 4.0 works
- [ ] Wording is clear and not intimidating

---

## Project 2: Recursive Landing Features

### Priority 1 (Must-have for Thanksgiving Launch)

#### Task 2.1: Add Transparent Layer (Prevent YouTube Clicks) ‚è≥
**Priority:** HIGH
**Time Estimate:** 1-2 hours
**File:** `recursive-landing/view.html`

**Problem:** Kids can click YouTube logo/title and navigate to unprotected YouTube.

**Solution:** Add transparent overlay that shows link but doesn't allow clicks.

**Implementation:**
```html
<!-- Add after YouTube player div -->
<div id="youtube-link-overlay" style="
  position: absolute;
  bottom: 60px;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 12px;
  text-align: center;
  font-size: 14px;
  backdrop-filter: blur(4px);
  display: none;
">
  <p style="margin: 0; color: #d1d5db;">
    Source: <span id="youtube-link-text" style="font-family: monospace; color: white;"></span>
  </p>
  <p style="margin: 4px 0 0 0; font-size: 12px; color: #9ca3af;">
    (Link visible for transparency, not clickable for safety)
  </p>
</div>
```

**Behavior:**
- Shows YouTube URL as plain text (no hyperlink)
- Appears on hover or after pause
- Cannot be clicked or copied easily
- Adds friction while maintaining transparency

**Success Criteria:**
- [ ] YouTube URL displayed as text (not link)
- [ ] Cannot click through to YouTube
- [ ] Still visible for attribution/transparency
- [ ] Works on mobile (touch)

---

#### Task 2.2: Add CSV Export Button ("See the Program") ‚è≥
**Priority:** HIGH
**Time Estimate:** 30-45 min
**File:** `recursive-landing/view.html`

**Feature:** Export complete list of titles and links as CSV file.

**UI Location:** Next to "Create Your Own" button

**Implementation:**
```html
<!-- Add button -->
<button id="export-csv-btn" class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-lg">
  üìã See the Program
</button>

<script>
document.getElementById('export-csv-btn').addEventListener('click', () => {
  if (!currentItems || currentItems.length === 0) {
    alert('No content loaded to export');
    return;
  }

  // Create CSV header
  let csv = 'Position,Title,Type,Link\n';

  // Add each item
  currentItems.forEach((item, index) => {
    const title = (item.title || `Item ${index + 1}`).replace(/"/g, '""'); // Escape quotes
    const type = item.type;
    let link = '';

    if (type === 'video') {
      if (item.url) {
        link = item.url;
      } else if (item.video_id) {
        // YouTube
        if (item.video_id.length === 11) {
          link = `https://youtube.com/watch?v=${item.video_id}`;
        } else {
          // Google Drive
          link = `https://drive.google.com/file/d/${item.video_id}/view`;
        }
      }
    } else if (type === 'image') {
      link = item.image_url || '';
    }

    csv += `${index + 1},"${title}",${type},"${link}"\n`;
  });

  // Create download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${currentContent.title || 'playlist'}-program.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
});
</script>
```

**Success Criteria:**
- [ ] Button appears next to "Create Your Own"
- [ ] CSV downloads with all titles and links
- [ ] Format: Position, Title, Type, Link
- [ ] Filename includes playlist title

---

#### Task 2.3: Add Calendar .ics Generation ‚è≥
**Priority:** HIGH
**Time Estimate:** 1.5-2 hours
**File:** `recursive-landing/view.html`

**Feature:** "Put in your calendar" button to generate .ics file for ritual/playlist.

**UI Location:** Next to "Create Your Own" button

**Implementation:**

**Step 1: Create ICS Utility Function**
```javascript
function generateICS(title, description, startDate, durationMinutes, url) {
  const start = new Date(startDate);
  const end = new Date(start.getTime() + durationMinutes * 60000);

  // Format dates as YYYYMMDDTHHMMSSZ (UTC)
  const formatDate = (date) => {
    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
  };

  const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Recursive.Eco//Family Art Ritual//EN
BEGIN:VEVENT
UID:${Date.now()}-${Math.random().toString(36)}@recursive.eco
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(start)}
DTEND:${formatDate(end)}
SUMMARY:${title}
DESCRIPTION:${description}\\n\\nLink: ${url}
URL:${url}
END:VEVENT
END:VCALENDAR`;

  return icsContent;
}

function downloadICS(icsContent, filename) {
  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

**Step 2: Add UI**
```html
<!-- Calendar Button -->
<button id="calendar-btn" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-lg">
  üìÖ Put in Your Calendar
</button>

<!-- Calendar Modal -->
<div id="calendar-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
  <div style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; width: 90%;">
    <h3 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">
      Schedule Your Ritual
    </h3>

    <label style="display: block; margin-bottom: 8px; font-weight: 600;">
      Choose when you want to do this ritual:
    </label>
    <input
      type="datetime-local"
      id="ritual-datetime"
      style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 16px;"
    />

    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button id="calendar-cancel" style="padding: 12px 24px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
        Cancel
      </button>
      <button id="calendar-download" style="padding: 12px 24px; background: #2563eb; color: white; border-radius: 6px; font-weight: 600;">
        Download Calendar Invite
      </button>
    </div>
  </div>
</div>

<script>
// Show modal
document.getElementById('calendar-btn').addEventListener('click', () => {
  document.getElementById('calendar-modal').style.display = 'flex';

  // Set default to tomorrow at 10am
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(10, 0, 0, 0);

  const dateInput = document.getElementById('ritual-datetime');
  dateInput.value = tomorrow.toISOString().slice(0, 16);
});

// Cancel
document.getElementById('calendar-cancel').addEventListener('click', () => {
  document.getElementById('calendar-modal').style.display = 'none';
});

// Download
document.getElementById('calendar-download').addEventListener('click', () => {
  const datetime = document.getElementById('ritual-datetime').value;

  if (!datetime) {
    alert('Please select a date and time');
    return;
  }

  const startDate = new Date(datetime);
  const title = `Family Art Ritual ‚Äì ${currentContent.title || 'Playlist'}`;
  const description = currentContent.description || 'Watch the calm playlist, explore the content, and enjoy this ritual together.';
  const url = window.location.href;
  const durationMinutes = 30; // Default 30 min

  const icsContent = generateICS(title, description, startDate, durationMinutes, url);
  const filename = `family-ritual-${currentContent.title?.toLowerCase().replace(/\s+/g, '-') || 'playlist'}.ics`;

  downloadICS(icsContent, filename);

  document.getElementById('calendar-modal').style.display = 'none';

  alert('Calendar invite downloaded! Add it to your calendar app.');
});
</script>
```

**Success Criteria:**
- [ ] Button appears and opens modal
- [ ] Date/time picker defaults to tomorrow 10am
- [ ] Download generates valid .ics file
- [ ] File imports correctly to Google Calendar / Apple Calendar
- [ ] Event includes title, description, link back to playlist

---

### Priority 2 (Nice-to-have)

#### Task 2.4: Import from YouTube (Local Render) ‚è≥
**Priority:** MEDIUM
**Time Estimate:** 1 hour (with Option A - reuse creator API)
**Files:** `recursive-landing/index.html`, `recursive-landing/view.html`, `recursive-creator/app/api/extract-playlist/route.ts`

**Feature:** Let users paste YouTube playlist URL, import locally, and view without saving to database.

**Architecture:** Option A - Reuse recursive-creator API

**Implementation Steps:**

**Step 1: Enable CORS on Creator API (5 min)**

File: `recursive-creator/app/api/extract-playlist/route.ts`

```typescript
export async function POST(request: NextRequest) {
  try {
    const { playlistUrl } = await request.json();

    // ... existing logic ...

    return NextResponse.json({
      videos,
      count: videos.length,
      playlistTitle: data.items[0]?.snippet?.channelTitle || 'YouTube Playlist'
    }, {
      headers: {
        'Access-Control-Allow-Origin': 'https://recursive.eco',
        'Access-Control-Allow-Methods': 'POST',
        'Access-Control-Allow-Headers': 'Content-Type'
      }
    });
  } catch (error) {
    // ... error handling ...
  }
}

// Add OPTIONS handler for CORS preflight
export async function OPTIONS() {
  return new NextResponse(null, {
    headers: {
      'Access-Control-Allow-Origin': 'https://recursive.eco',
      'Access-Control-Allow-Methods': 'POST',
      'Access-Control-Allow-Headers': 'Content-Type'
    }
  });
}
```

**Step 2: Add Import UI to Landing Page (30 min)**

File: `recursive-landing/index.html` (or wherever appropriate)

```html
<!-- Import Button -->
<button id="import-playlist-btn" class="btn-primary">
  üé¨ Try Importing a YouTube Playlist
</button>

<!-- Import Modal -->
<div id="import-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3>Import YouTube Playlist</h3>
    <p>Paste a YouTube playlist URL to preview it instantly (no account needed)</p>

    <input
      type="text"
      id="playlist-url-input"
      placeholder="https://youtube.com/playlist?list=PLxxx..."
      style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; margin: 16px 0;"
    />

    <div id="import-error" style="display: none; color: #dc2626; background: #fee2e2; padding: 12px; border-radius: 6px; margin: 16px 0;"></div>
    <div id="import-loading" style="display: none; color: #2563eb;">
      Importing playlist... Please wait.
    </div>

    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
      <button id="import-cancel">Cancel</button>
      <button id="import-submit" class="btn-primary">Import & Preview</button>
    </div>
  </div>
</div>

<script>
// Show modal
document.getElementById('import-playlist-btn').addEventListener('click', () => {
  document.getElementById('import-modal').style.display = 'block';
  document.getElementById('import-error').style.display = 'none';
});

// Cancel
document.getElementById('import-cancel').addEventListener('click', () => {
  document.getElementById('import-modal').style.display = 'none';
  document.getElementById('playlist-url-input').value = '';
});

// Import
document.getElementById('import-submit').addEventListener('click', async () => {
  const url = document.getElementById('playlist-url-input').value.trim();
  const errorDiv = document.getElementById('import-error');
  const loadingDiv = document.getElementById('import-loading');

  if (!url) {
    errorDiv.textContent = 'Please enter a playlist URL';
    errorDiv.style.display = 'block';
    return;
  }

  errorDiv.style.display = 'none';
  loadingDiv.style.display = 'block';

  try {
    // Call recursive-creator API (with CORS enabled)
    const response = await fetch('https://creator.recursive.eco/api/extract-playlist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playlistUrl: url })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to fetch playlist');
    }

    const { videos, playlistTitle } = await response.json();

    // Create local playlist data (matches Supabase format)
    const playlistData = {
      id: 'local-' + Date.now(),
      document_data: {
        title: playlistTitle || 'Imported Playlist',
        description: 'Imported from YouTube (temporary - not saved)',
        items: videos.map((v, i) => ({
          position: i + 1,
          type: 'video',
          video_id: v.video_id,
          title: v.title,
          url: v.url
        }))
      }
    };

    // Store in localStorage
    localStorage.setItem('local_playlist', JSON.stringify(playlistData));

    // Redirect to viewer
    window.location.href = '/view.html?local=true';

  } catch (error) {
    console.error('Import error:', error);
    errorDiv.textContent = error.message || 'Failed to import playlist. Please check the URL and try again.';
    errorDiv.style.display = 'block';
    loadingDiv.style.display = 'none';
  }
});
</script>
```

**Step 3: Update Viewer to Support localStorage (20 min)**

File: `recursive-landing/view.html`

```javascript
// Add to loadContent() at the very start
async function loadContent() {
  const urlParams = new URLSearchParams(window.location.search);
  const contentId = urlParams.get('id');
  const isLocal = urlParams.get('local') === 'true';

  // Check for local playlist first
  if (isLocal) {
    const localData = localStorage.getItem('local_playlist');

    if (!localData) {
      showError('No local playlist found. Please import a playlist first.');
      return;
    }

    try {
      const data = JSON.parse(localData);

      currentContent = {
        title: data.document_data.title || 'Imported Playlist',
        description: data.document_data.description || '',
        items: data.document_data.items || []
      };

      if (currentContent.items.length === 0) {
        throw new Error('Playlist has no items');
      }

      currentItems = currentContent.items;
      console.log('‚úÖ Loaded local playlist:', currentItems.length, 'items');

      // Update page metadata
      document.getElementById('page-title').textContent = currentContent.title + ' (Preview)';

      // Show local playlist notice
      showLocalNotice();

      // Show content
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('content-wrapper').classList.remove('hidden');

      // Display first item
      displayItem(currentIndex);

    } catch (error) {
      console.error('Error loading local playlist:', error);
      showError('Failed to load local playlist');
    }

    return; // Don't try to fetch from Supabase
  }

  // Existing Supabase fetch logic continues below...
  // ...
}

// Add notice for local playlists
function showLocalNotice() {
  const notice = document.createElement('div');
  notice.style.cssText = `
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: #fef3c7;
    border: 2px solid #f59e0b;
    color: #92400e;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 100;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  `;
  notice.innerHTML = `
    üí° This is a temporary preview (stored in your browser).
    <a href="https://creator.recursive.eco" style="color: #92400e; text-decoration: underline; font-weight: bold;">
      Create a free account
    </a> to save it permanently.
  `;
  document.body.appendChild(notice);
}
```

**Success Criteria:**
- [ ] Import button visible on landing page
- [ ] Modal opens with URL input
- [ ] Paste playlist URL ‚Üí fetches from creator API
- [ ] Stores in localStorage
- [ ] Redirects to viewer with ?local=true
- [ ] Viewer loads from localStorage (not Supabase)
- [ ] Shows "temporary preview" notice with CTA to create account

**Benefits:**
- ‚úÖ No authentication required
- ‚úÖ Instant preview
- ‚úÖ Gateway to account creation
- ‚úÖ Reuses existing API (no duplication)
- ‚úÖ Works offline once imported

---

#### Task 2.5: Email Collector CTA ‚è≥
**Priority:** LOW (can wait until after Thanksgiving)
**Time Estimate:** 1.5-2 hours
**Files:** `recursive-landing/view.html`, Supabase (new table)

**Feature:** Collect email for Vibe Coding 201 + kids' playlists interest.

**Note:** This is documented in detail in the root claude.md. Can implement after priority features are complete.

---

### NEW TASKS (Added 2025-11-23 - User Feedback on Initial Implementation)

#### Task 2.6: Redesign YouTube Source Attribution ‚è≥
**Priority:** HIGH (user feedback: "I hated the source")
**Time Estimate:** 30-45 min
**File:** `recursive-landing/view.html`

**Problem:** Currently implemented source attribution is always visible and takes too much screen space, even in fullscreen mode.

**User Feedback:**
> "I hated the source. You can make it disappear. What I was planning was that you would build a rectangular layer just behind the polygon with play stop functions that covers the full screen, so that when people click, a pop up would appear with the source. Now it is always on and taking space from screen even in full screen."

**Proposed Solutions:**

**Option 1: Clickable Transparent Layer with Popup (RECOMMENDED)**
- Create rectangular layer covering the entire YouTube iframe
- Layer sits behind play/stop controls (lower z-index)
- Clicking the layer shows a popup modal with source information
- Popup can be dismissed by clicking X or outside the modal
- Maintains transparency and safety while removing visual clutter

**Option 2: Right-Click Context Menu**
- Show source only when user right-clicks on video
- Custom context menu appears with source link
- Less discoverable but completely invisible until needed

**Option 3: CSV-Only Attribution**
- Remove source display from viewer entirely
- Source links only appear in CSV export
- Simplest implementation, but reduces transparency

**Implementation (Option 1 - Recommended):**

```html
<!-- Transparent Overlay Layer (covers video but not controls) -->
<div id="video-source-layer" style="
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 60px; /* Leave room for controls */
  background: transparent;
  z-index: 1; /* Behind controls (controls are z-index 2) */
  cursor: pointer;
" onclick="showSourcePopup()">
</div>

<!-- Source Popup Modal -->
<div id="source-popup" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
  <div style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); position: relative;">
    <button onclick="closeSourcePopup()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>

    <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 16px; color: #111827;">
      üì∫ Video Source
    </h3>

    <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">
      This content is from:
    </p>

    <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
      <p id="source-url-display" style="font-family: monospace; font-size: 13px; color: #374151; word-break: break-all; margin: 0;">
        <!-- URL populated dynamically -->
      </p>
    </div>

    <p style="font-size: 12px; color: #9ca3af; font-style: italic;">
      Link visible for transparency. Not clickable for child safety.
    </p>
  </div>
</div>

<script>
function showSourcePopup() {
  const currentItem = currentItems[currentIndex];
  const videoId = currentItem.video_id;
  const url = currentItem.url || `https://youtube.com/watch?v=${videoId}`;

  document.getElementById('source-url-display').textContent = url;
  document.getElementById('source-popup').style.display = 'flex';
}

function closeSourcePopup() {
  document.getElementById('source-popup').style.display = 'none';
}

// Also close on clicking outside the modal
document.getElementById('source-popup').addEventListener('click', (e) => {
  if (e.target.id === 'source-popup') {
    closeSourcePopup();
  }
});
</script>
```

**Steps:**
1. Remove current always-visible source attribution
2. Add transparent overlay layer with z-index management
3. Create popup modal for source display
4. Wire up click handlers
5. Test that controls still work (higher z-index)
6. Test popup appears and dismisses correctly

**Success Criteria:**
- [ ] No visible source display during normal viewing
- [ ] Transparent layer covers video (not controls)
- [ ] Clicking video area shows popup with source
- [ ] Popup dismisses with X button or clicking outside
- [ ] Play/stop controls still work normally
- [ ] No screen space wasted in fullscreen mode

---

#### Task 2.7: Fix CSV Export Titles ‚è≥
**Priority:** HIGH
**Time Estimate:** 20-30 min (if titles in Supabase) OR 1-2 hours (if need YouTube API)
**File:** `recursive-landing/view.html`

**Problem:** CSV export showing generic titles like "Item 1", "Item 2" instead of actual video/image names.

**User Feedback:**
> "In the program I am not seeing the name of the movies or files... Is it possible to retrieve that or maybe I would need to save that information in Supabase through Creator for people to be able to see here?"

**Root Cause Analysis:**

Current CSV generation:
```javascript
const title = (item.title || `Item ${index + 1}`).replace(/"/g, '""');
```

This suggests `item.title` is undefined or empty.

**Investigation Steps:**
1. Check Supabase schema - does `document_data.items[]` have a `title` field?
2. Check recursive-creator - when importing playlists, does it save video titles to Supabase?
3. Check YouTube API response - are titles being extracted during import?

**Possible Solutions:**

**Solution A: Titles Already in Supabase (Quick Fix - 20-30 min)**

If titles are already stored in Supabase but not being read correctly:
- Check the data structure in console
- Fix the property path (might be `item.video_title` or nested differently)
- Test with existing playlists

**Solution B: Fetch Titles from YouTube API (Medium Effort - 1-2 hrs)**

If titles aren't in Supabase, fetch them on-demand:

```javascript
// Add at top of view.html
const YOUTUBE_API_KEY = 'your-api-key'; // Or use proxy

async function fetchYouTubeTitle(videoId) {
  try {
    const response = await fetch(
      `https://www.googleapis.com/youtube/v3/videos?id=${videoId}&part=snippet&key=${YOUTUBE_API_KEY}`
    );
    const data = await response.json();
    return data.items?.[0]?.snippet?.title || 'Untitled Video';
  } catch (error) {
    console.error('Failed to fetch title:', error);
    return `Video ${videoId}`;
  }
}

// Modify CSV export button handler
document.getElementById('export-csv-btn').addEventListener('click', async () => {
  // ... existing validation ...

  let csv = 'Position,Title,Type,Link\n';

  // Fetch titles for videos that don't have them
  const itemsWithTitles = await Promise.all(
    currentItems.map(async (item, index) => {
      let title = item.title;

      // If no title and it's a YouTube video, fetch it
      if (!title && item.type === 'video' && item.video_id?.length === 11) {
        title = await fetchYouTubeTitle(item.video_id);
      }

      return { ...item, title: title || `Item ${index + 1}` };
    })
  );

  // Generate CSV with fetched titles
  itemsWithTitles.forEach((item, index) => {
    // ... rest of CSV generation ...
  });
});
```

**Solution C: Update Creator to Save Titles (Best Long-term - requires creator changes)**

Modify recursive-creator import handlers to save titles to Supabase:
- Update `handleImportPlaylist` in `app/dashboard/sequences/new/page.tsx`
- Ensure YouTube API response titles are saved to `items[].title`
- This fixes it for all future imports

**Recommendation:**
1. First check Solution A (quick inspection)
2. If titles missing, implement Solution B for immediate fix
3. Later implement Solution C for permanent solution

**ROOT CAUSE IDENTIFIED (2025-11-23):**
- ‚úÖ Investigated: Titles are NOT being saved to Supabase by recursive-creator
- ‚ùå When importing YouTube playlists/videos, only video IDs are saved, not titles
- üîß **Fix needed in recursive-creator FIRST**: Modify import handlers to save YouTube titles to `items[].title` field
- üìã Once titles are saved in DB, CSV export will work automatically (already reads `item.title`)

**Success Criteria:**
- [ ] recursive-creator saves YouTube titles when importing (PRIMARY FIX)
- [ ] CSV export shows actual video titles from YouTube
- [ ] CSV export shows actual image filenames (if applicable)
- [ ] Fallback to "Item N" only if title truly unavailable
- [ ] Export works for both saved playlists and local imports

---

#### Task 2.8: Google Calendar Direct Integration (Research + Optional Implementation) ‚è≥
**Priority:** MEDIUM (nice-to-have enhancement)
**Time Estimate:** 30 min research + 1-2 hours implementation (if feasible)
**File:** `recursive-landing/view.html`

**Feature Request:**
> "Is it possible that instead of downloading the .ics file, we can have an action to add to the calendar directly?"

**Research Questions:**

1. **Can we add to Google Calendar without OAuth?**
   - Google Calendar API requires OAuth for write access
   - But there's a workaround: Google Calendar URL scheme

2. **Google Calendar URL Scheme (No Auth Required):**

```
https://calendar.google.com/calendar/render?action=TEMPLATE&text=EVENT_TITLE&dates=START_TIME/END_TIME&details=DESCRIPTION&location=LOCATION
```

**Example:**
```javascript
function addToGoogleCalendar() {
  const title = encodeURIComponent('Family Art Ritual ‚Äì ' + currentContent.title);
  const start = new Date(datetime);
  const end = new Date(start.getTime() + 30 * 60000); // 30 min later

  // Format: YYYYMMDDTHHmmssZ
  const formatGoogleDate = (date) => {
    return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
  };

  const startTime = formatGoogleDate(start);
  const endTime = formatGoogleDate(end);

  const description = encodeURIComponent(
    currentContent.description + '\n\nWatch at: ' + window.location.href
  );

  const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startTime}/${endTime}&details=${description}`;

  window.open(url, '_blank');
}
```

**Pros:**
- ‚úÖ No OAuth required
- ‚úÖ Works instantly
- ‚úÖ User stays in control (can review before adding)
- ‚úÖ Works on mobile

**Cons:**
- ‚ùå Google Calendar only (not Apple/Outlook)
- ‚ùå Requires Google account + being logged in
- ‚ùå Opens new tab (might get blocked by popup blockers)

**Proposed Implementation:**

Add both options side by side:

```html
<!-- Updated Calendar Modal Buttons -->
<div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
  <button id="calendar-cancel" style="padding: 12px 24px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
    Cancel
  </button>
  <button id="calendar-download-ics" style="padding: 12px 24px; background: #6b7280; color: white; border-radius: 6px; font-weight: 600;">
    üì• Download .ics
  </button>
  <button id="calendar-add-google" style="padding: 12px 24px; background: #2563eb; color: white; border-radius: 6px; font-weight: 600;">
    üìÖ Add to Google Calendar
  </button>
</div>
```

**Success Criteria:**
- [ ] Research confirms Google Calendar URL scheme works without OAuth
- [ ] "Add to Google Calendar" button opens pre-filled event form
- [ ] User can review and confirm before adding
- [ ] Works on both desktop and mobile
- [ ] .ics download still available for non-Google users
- [ ] Clear messaging about which calendar services are supported

**Alternative:** If URL scheme doesn't work well, keep only .ics download (universal compatibility).

---

### Task 1.3: Add YouTube Kids URL Support (Recursive Creator) ‚è≥
**Priority:** MEDIUM
**Time Estimate:** 30-60 min
**File:** `recursive-creator/app/dashboard/sequences/new/page.tsx`

**Problem:** YouTube Kids URLs like `https://www.youtubekids.com/watch?v=Gh-XKNuvvC4&hl=en-GB` return 403 Forbidden error.

**User Feedback:**
> "Can you add an action on recursive-creator to allow for youtube kids links, like this one? https://www.youtubekids.com/watch?v=Gh-XKNuvvC4&hl=en-GB"

**Current Status:**
- Pattern matching added to `extractYouTubeId` function
- URL detection updated to recognize `youtubekids.com`
- **ERROR:** 403 Forbidden from `/api/proxy-image` endpoint

**Error Details:**
```
GET https://creator.recursive.eco/api/proxy-image?url=https%3A%2F%2Fwww.youtubekids.com%2Fwatch%3Fv%3DGh-XKNuvvC4%26hl%3Den-GB 403 (Forbidden)
```

**Root Cause:**
The proxy-image endpoint is being called with a YouTube Kids URL, but the endpoint likely doesn't support or allow requests to `youtubekids.com` domain.

**Investigation Steps:**
1. Check `recursive-creator/app/api/proxy-image/route.ts`
2. See if there's domain whitelisting/blacklisting
3. Determine if YouTube Kids blocks thumbnail scraping (likely!)

**Proposed Solutions:**

**Solution A: Use YouTube Kids Video ID with Regular YouTube Thumbnail**
- Extract video ID from YouTube Kids URL
- Use regular YouTube thumbnail URL: `https://img.youtube.com/vi/{videoId}/maxresdefault.jpg`
- Most YouTube Kids videos are also on regular YouTube with same ID
- Avoids proxy-image endpoint entirely

```typescript
// In extractYouTubeId function
const patterns = [
  /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
  /youtube\.com\/shorts\/([^&\n?#]+)/,
  /youtubekids\.com\/watch\?v=([^&\n?#]+)/, // Extract just the video ID
  /^([a-zA-Z0-9_-]{11})$/
];

// Then use YouTube thumbnail URL, not YouTube Kids URL
const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
```

**Solution B: Update Proxy-Image to Allow YouTube Kids Domain**

If proxy-image has domain restrictions:

```typescript
// In app/api/proxy-image/route.ts
const allowedDomains = [
  'youtube.com',
  'youtubekids.com', // ADD THIS
  'ytimg.com',
  'i.ytimg.com',
  'googlevideo.com'
];

// Check if URL domain is allowed
const url = new URL(imageUrl);
if (!allowedDomains.some(domain => url.hostname.endsWith(domain))) {
  return new NextResponse('Domain not allowed', { status: 403 });
}
```

**Solution C: Skip Thumbnail for YouTube Kids (Temporary Fix)**

```typescript
// In detectUrlType or URL processing
if (trimmedUrl.includes('youtubekids.com')) {
  return {
    type: 'video',
    processedUrl: trimmedUrl,
    skipThumbnail: true // Don't try to fetch thumbnail
  };
}
```

**Recommendation:** Start with Solution A (use regular YouTube thumbnails). Most videos are cross-posted.

**Success Criteria:**
- [ ] YouTube Kids URLs accepted in URL input
- [ ] Video ID correctly extracted
- [ ] Thumbnail loads (from YouTube, not YouTube Kids)
- [ ] Video plays in viewer
- [ ] No 403 errors in console
- [ ] Works with both `youtubekids.com` and `youtube.com` URLs

---

## Implementation Order

### ‚úÖ COMPLETED (Initial Implementation - Nov 23)

1. ‚úÖ Task 2.2: CSV export button (30-45 min)
2. ‚úÖ Task 2.1: Transparent layer for YouTube (1-2 hrs) - **NEEDS REDESIGN** (see Task 2.6)
3. ‚úÖ Task 2.3: Calendar .ics generation (1.5-2 hrs)

---

### üî¥ HIGH PRIORITY (Fix User Feedback Issues)

**Phase 2B: Recursive Landing Fixes**
**Total Time:** ~1.5-2.5 hours

4. ‚è≥ **Task 2.6: Redesign YouTube Source Attribution** (30-45 min)
   - Remove always-visible source display
   - Add clickable transparent layer with popup
   - Test controls still work

5. ‚è≥ **Task 2.7: Fix CSV Export Titles** (20-30 min if titles in Supabase, 1-2 hrs if need API)
   - Investigate where titles are stored
   - Implement solution to show actual video names
   - Test with existing playlists

---

### üü° MEDIUM PRIORITY (Enhancements)

**Phase 2C: Optional Improvements**
**Total Time:** ~2-3.5 hours

6. ‚è≥ **Task 2.8: Google Calendar Direct Integration** (30 min research + 1-2 hrs implementation)
   - Research Google Calendar URL scheme
   - Add "Add to Google Calendar" button
   - Keep .ics download for other calendar apps

7. ‚è≥ **Task 1.3: YouTube Kids URL Support** (30-60 min)
   - Fix 403 error from proxy-image
   - Use regular YouTube thumbnails
   - Test with YouTube Kids URLs

---

### üü¢ LOWER PRIORITY (Deferred)

**Phase 1: Recursive Creator (Quick Wins)**
**Total Time:** ~45-75 min

8. ‚è≥ Task 1.1: Fix import append behavior (30-60 min)
9. ‚è≥ Task 1.2: Update license wording (10-15 min)

**Phase 3: Recursive Landing (Enhanced UX)**
**Total Time:** ~1 hour

10. ‚è≥ Task 2.4: Local playlist import with Option A (1 hr)
   - Step 1: Enable CORS on creator API
   - Step 2: Add import UI to landing
   - Step 3: Update viewer for localStorage

**Phase 4: Email Collector (Post-Thanksgiving)**
**Total Time:** 1.5-2 hours (optional)

11. ‚è≥ Task 2.5: Email collector CTA

---

## Testing Checklist

### Recursive Creator
- [ ] Import YouTube playlist with existing items ‚Üí appends to end
- [ ] Import Drive folder with existing items ‚Üí appends to end
- [ ] License checkbox has new wording
- [ ] License checkbox required to publish

### Recursive Landing - Priority 1
- [ ] CSV export downloads with all titles and links
- [ ] YouTube link visible but not clickable
- [ ] Calendar button opens modal
- [ ] Calendar download generates valid .ics file
- [ ] .ics file imports to Google Calendar successfully

### Recursive Landing - Priority 2
- [ ] Import YouTube playlist without login
- [ ] Playlist stores in localStorage
- [ ] Viewer loads from localStorage with ?local=true
- [ ] "Create account to save" CTA appears

---

## Deployment Strategy

**Branch:** Continue on `feature/publishing-workflow-20251119` (both repos)

**Steps:**
1. Implement all features in dev branch
2. Test locally (npm run dev)
3. Push to GitHub
4. Deploy to Vercel preview
5. User tests on preview URL
6. If good ‚Üí merge to main
7. Deploy to production

---

## Success Metrics

**Launch Ready:**
- ‚úÖ CSV export (attribution)
- ‚úÖ YouTube link visible (transparency) but not clickable (safety)
- ‚úÖ Calendar scheduling (family planning)
- ‚úÖ Import append working (creator UX)

**Bonus (Enhanced UX):**
- ‚úÖ Local playlist import (try before account)

**Post-Launch:**
- Email collector (gather feedback)

---

## Notes

- Keep README.md updated with safety reasoning
- Document all features in claude.md
- Test on mobile (most families use tablets/phones)
- Verify Thanksgiving deadline feasibility after Phase 1+2 complete

---

**Ready to start!** Let's begin with Phase 1 (Creator fixes) ‚Üí Phase 2 (Landing priority 1) ‚Üí Phase 3 (Local import).
