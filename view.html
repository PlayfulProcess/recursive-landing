<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">View Content - Recursive.eco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <style>
        .content-item {
            max-height: 80vh;
            object-fit: contain;
        }
        .video-embed {
            width: 100%;
            aspect-ratio: 16/9;
            max-height: 60vh;
            border: none;
        }

        /* YouTube end-screen overlay */
        .video-overlay {
            position: absolute;
            inset: 0;
            background: rgb(0, 0, 0);
            border-radius: 0.5rem;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            z-index: 10;
        }
        .video-overlay.active {
            display: flex;
        }
        .video-overlay-button {
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
            min-width: 160px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        .video-overlay-button:hover {
            transform: scale(1.05);
        }
        @media (max-width: 640px) {
            .video-overlay-buttons {
                flex-direction: column;
                width: 100%;
                padding: 0 1rem;
            }
            .video-overlay-button {
                width: 100%;
            }
        }
        .content-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }
        #content-display {
            width: 100%;
            max-width: 100%;
        }

        /* Non-fullscreen YouTube iframe sizing - target iframe directly */
        #content-display iframe {
            width: 100% !important;
            max-width: 1200px !important;
            height: auto !important;
            aspect-ratio: 16/9 !important;
            display: block !important;
            margin: 0 auto !important;
        }

        /* Fullscreen styles */
        #viewer-container:fullscreen {
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #viewer-container:fullscreen .content-item {
            max-height: 100vh;
            max-width: 100vw;
        }

        #viewer-container:fullscreen .page-indicator {
            opacity: 0;
            pointer-events: none;
        }

        #viewer-container:fullscreen #content-wrapper > div:first-child {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Fullscreen YouTube player sizing - height-based approach */
        #viewer-container:fullscreen #content-display > div {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100%;
            height: 100vh;
        }

        #viewer-container:fullscreen #content-display > div > div[id^="youtube-player-"] {
            height: 100vh !important;
            width: auto !important;
            max-width: 100vw !important;
        }

        /* Target the YouTube iframe directly */
        #viewer-container:fullscreen #content-display iframe {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;  /* Override non-fullscreen max-width */
            aspect-ratio: auto !important;  /* Let object-fit handle sizing */
            object-fit: contain !important;
        }

        #viewer-container:fullscreen #video-end-overlay {
            width: 100vw !important;
            height: 100vh !important;
        }

        /* Fullscreen controls - reposition to top as header with auto-hide */
        #viewer-container:fullscreen #video-controls-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            z-index: 200;
            display: flex !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #viewer-container:fullscreen #video-controls-bar.hidden-controls {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
        }

        /* Hide control bar completely for images in fullscreen */
        #viewer-container:fullscreen #video-controls-bar.hide-for-images {
            display: none !important;
        }

        /* Transparent interaction layer to capture mouse events over YouTube iframe */
        #video-interaction-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* Above YouTube iframe (z-0), below controls (z-50+) */
            background: transparent;
            display: none; /* Hidden by default */
            cursor: pointer;
            /* Cut out top-right (Copy link) and bottom-right (YouTube logo) corners */
            clip-path: polygon(
                0 0,                              /* Top-left */
                80% 0,                            /* CHANGED: Starts cutout earlier (wider hole) */
                80% 120px,                        /* CHANGED: Goes deeper down (taller hole) */
                100% 120px,                       /* CHANGED: Connects to right edge */
                100% calc(100% - 80px),           /* Right edge to bottom cutout */
                calc(100% - 100px) calc(100% - 80px),  /* Bottom-right cutout */
                calc(100% - 100px) 100%,
                0 100%,                           /* Bottom-left */
                0 0                               /* Close */            );
        }

        /* Only active when content is video */
        #viewer-container.video-mode #video-interaction-layer {
            display: block;
        }

        /* Black overlay to hide YouTube thumbnails when paused */
        #thumbnail-blocker {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: black;
            z-index: 15; /* Above interaction layer (10), below controls (50+) */
            display: none; /* Hidden by default */
            pointer-events: none; /* Don't block clicks, let interaction layer handle them */
        }

        /* Show thumbnail blocker when video is paused */
        #viewer-container.video-paused #thumbnail-blocker {
            display: block;
        }

        .page-indicator {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Load inline component system -->
    <script src="/assets/js/components/site-shell-inline.js"></script>

    <!-- Header Component -->
    <site-header></site-header>

    <!-- Hero Section -->
    <div id="hero-section" class="bg-gradient-to-br from-purple-50 to-pink-100 py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 id="content-title" class="text-4xl font-bold text-gray-900 mb-3">Loading...</h1>
            <p id="content-description" class="text-xl text-gray-600 mb-4"></p>
        </div>
    </div>

    <!-- Content Viewer -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="viewer-container" class="relative bg-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Loading State -->
            <div id="loading-state" class="flex items-center justify-center h-96">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading content...</p>
                </div>
            </div>

            <!-- Error State (404) -->
            <div id="error-state" class="hidden flex items-center justify-center h-96">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Content Not Found</h2>
                    <p class="text-gray-600 mb-6">This content doesn't exist or hasn't been published yet.</p>
                    <a href="/" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Return Home
                    </a>
                </div>
            </div>

            <!-- Content Display -->
            <div id="content-wrapper" class="hidden">
                <div class="relative content-container">
                    <div id="content-display" class="w-full"></div>

                    <!-- Transparent interaction layer to capture mouse events over YouTube iframe -->
                    <div id="video-interaction-layer"></div>

                    <!-- Black overlay to hide YouTube thumbnails when paused -->
                    <div id="thumbnail-blocker"></div>

                    <!-- Page Indicator -->
                    <div class="page-indicator">
                        <span id="current-page">1</span> / <span id="total-pages">1</span>
                    </div>

                    <!-- Persistent Video End Overlay -->
                    <div id="video-end-overlay" class="video-overlay" style="display: none; z-index: 9999;">
                        <div style="text-align: center;">
                            <h3 id="overlay-title" style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 8px;">
                                Video Complete
                            </h3>
                            <p style="color: #d1d5db;">What would you like to do next?</p>
                        </div>

                        <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                            <button id="replay-btn-persistent" class="video-overlay-button" style="background: #9333ea; color: white;">
                                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Replay
                            </button>

                            <button id="next-btn-persistent" class="video-overlay-button" style="background: #2563eb; color: white;">
                                Next
                                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Navigation Controls -->
                <div id="video-controls-bar" class="flex items-center justify-center gap-3 p-4 border-t flex-wrap">
                    <button id="prev-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        ‚Üê Previous
                    </button>

                    <!-- Video Controls (Show only for videos) -->
                    <button id="skip-back-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors hidden" title="Skip back 10 seconds">
                        ‚è™ 10s
                    </button>

                    <button id="play-pause-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors hidden">
                        <span id="play-icon">‚ñ∂ Play</span>
                        <span id="pause-icon" style="display: none;">‚è∏ Pause</span>
                    </button>

                    <button id="skip-forward-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors hidden" title="Skip forward 10 seconds">
                        10s ‚è©
                    </button>

                    <button id="fullscreen-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        ‚õ∂ Fullscreen
                    </button>
                    <button id="next-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons Section (below viewer) -->
        <div class="mt-8 flex flex-wrap gap-3 justify-center">
            <a href="https://creator.recursive.eco/dashboard/sequences/new" target="_blank" rel="noopener noreferrer" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold shadow-lg">
                ‚ú® Create Your Own
            </a>
            <button id="export-csv-btn" class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-lg">
                üìã See the Program
            </button>
            <button id="calendar-btn" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-lg">
                üìÖ Include in Your Calendar
            </button>
            <button id="report-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold shadow-lg">
                ‚ö†Ô∏è Report
            </button>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);">
            <h3 style="font-size: 24px; font-weight: bold; margin-bottom: 8px; color: #111827;">
                üìÖ Schedule Your Ritual
            </h3>
            <p style="font-size: 14px; color: #6b7280; margin-bottom: 24px;">
                Choose when you want to experience this content together
            </p>

            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                Date & Time:
            </label>
            <input
                type="datetime-local"
                id="ritual-datetime"
                style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; margin-bottom: 24px; font-size: 16px;"
            />

            <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                <button id="calendar-cancel" style="padding: 12px 24px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-weight: 600; color: #374151; cursor: pointer; transition: all 0.2s;">
                    Cancel
                </button>
                <button id="calendar-download-ics" style="padding: 12px 24px; background: #6b7280; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(107, 114, 128, 0.3);">
                    üì• Download .ics
                </button>
                <button id="calendar-add-google" style="padding: 12px 24px; background: #2563eb; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);">
                    üìÖ Add to Google Calendar
                </button>
            </div>
        </div>
    </div>

    <!-- Source Popup Modal -->
    <div id="source-popup" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);" onclick="closeSourcePopup(event)">
        <div style="background: white; padding: 32px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); position: relative;" onclick="event.stopPropagation()">
            <button onclick="closeSourcePopup(event)" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#111827'" onmouseout="this.style.color='#6b7280'">√ó</button>

            <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 16px; color: #111827; padding-right: 32px;">
                üì∫ Video Source
            </h3>

            <p style="font-size: 14px; color: #6b7280; margin-bottom: 12px;">
                This content is from:
            </p>

            <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                <p id="source-url-display" style="font-family: monospace; font-size: 13px; color: #374151; word-break: break-all; margin: 0;">
                    <!-- URL populated dynamically -->
                </p>
            </div>

            <p style="font-size: 12px; color: #9ca3af; font-style: italic; margin: 0;">
                Link visible for transparency. Not clickable for child safety.
            </p>
        </div>
    </div>

    <!-- Report Content Modal -->
    <div id="report-modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); position: relative;">
            <button id="report-modal-close" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280; line-height: 1; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#111827'" onmouseout="this.style.color='#6b7280'">√ó</button>

            <h3 style="font-size: 24px; font-weight: bold; margin-bottom: 16px; color: #111827; padding-right: 32px;">
                ‚ö†Ô∏è Report Content
            </h3>

            <p style="font-size: 15px; color: #374151; margin-bottom: 24px; line-height: 1.6;">
                Did you find inappropriate content? Reporting will immediately unpublish this content and notify the administrator for review.
            </p>

            <p style="font-size: 14px; color: #6b7280; margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #ef4444;">
                <strong>This action cannot be undone.</strong> The content will be removed from public view.
            </p>

            <div id="report-error" style="display: none; background: #fef2f2; border: 2px solid #fca5a5; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <p style="color: #dc2626; font-size: 14px; margin: 0;"></p>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="report-cancel" style="padding: 12px 24px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-weight: 600; color: #374151; cursor: pointer; transition: all 0.2s;">
                    Cancel
                </button>
                <button id="report-submit" style="padding: 12px 24px; background: #ef4444; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);">
                    Report & Unpublish
                </button>
            </div>
        </div>
    </div>

    <!-- Footer Component -->
    <site-footer></site-footer>

    <script>
        // Initialize Supabase client
        const { createClient } = window.supabase;
        const supabaseClient = createClient(
            'https://evixjvagwjmjdjpbazuj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aXhqdmFnd2ptamRqcGJhenVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3Mjc5NDIsImV4cCI6MjA2OTMwMzk0Mn0.d7rp6xs9KswI7mGnw7V5XTARiJD4L9pAcEooI0zZg0E'
        );

        let currentContent = null;
        let currentItems = [];
        let currentIndex = 0;
        let youtubePlayer = null;
        let videoEnded = false;
        let youtubeApiReady = false;
        let isPlaying = false;

        // Load YouTube IFrame API dynamically
        console.log('üì∫ Loading YouTube IFrame API...');
        window.onYouTubeIframeAPIReady = function() {
            console.log('‚úÖ YouTube IFrame API ready!');
            youtubeApiReady = true;
        };

        // Dynamically inject YouTube API script
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Get content ID from URL (supports both /view/ID and /view.html?id=ID)
        const urlParams = new URLSearchParams(window.location.search);
        let contentId = urlParams.get('id');

        // If no query param, try to extract from pathname (e.g., /view/abc-123)
        if (!contentId) {
            const pathParts = window.location.pathname.split('/');
            // Check if URL is like /view/some-uuid
            if (pathParts[1] === 'view' && pathParts[2]) {
                contentId = pathParts[2];
            }
        }

        // Debug logging
        console.log('üîç Full URL:', window.location.href);
        console.log('üîç Pathname:', window.location.pathname);
        console.log('üîç Search params:', window.location.search);
        console.log('üîç Extracted Content ID:', contentId);

        // Load content from Supabase
        async function loadContent() {
            try {
                if (!contentId) {
                    throw new Error('No content ID provided');
                }

                console.log('üîç Fetching content:', contentId);

                const { data, error } = await supabaseClient
                    .from('user_documents')
                    .select('*')
                    .eq('id', contentId)
                    .eq('tool_slug', 'sequence') // Only sequences
                    .single();

                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    throw error;
                }

                if (!data) {
                    throw new Error('Content not found');
                }

                console.log('üì¶ Fetched data:', data);

                // CRITICAL: Check if published (now using boolean)
                const isPublished = data.document_data?.is_published === true;
                console.log('üîì Is published?', isPublished);

                if (!isPublished) {
                    console.warn('‚ö†Ô∏è Content not published');
                    throw new Error('Content not published');
                }

                // Map Supabase data to viewer structure
                currentContent = {
                    title: data.document_data.title || 'Untitled',
                    description: data.document_data.description || '',
                    items: data.document_data.items || []
                };

                if (currentContent.items.length === 0) {
                    throw new Error('Content has no items');
                }

                currentItems = currentContent.items;
                console.log('‚úÖ Loaded', currentItems.length, 'items');

                // Update page metadata
                document.getElementById('page-title').textContent = `${currentContent.title} - Recursive.eco`;
                document.getElementById('content-title').textContent = currentContent.title;
                document.getElementById('content-description').textContent = currentContent.description;
                document.getElementById('total-pages').textContent = currentItems.length;

                // Hide loading, show content
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('content-wrapper').classList.remove('hidden');

                // Display first item
                displayItem(0);

            } catch (err) {
                console.error('‚ùå Error loading content:', err);
                showError();
            }
        }

        // Display item at index
        function displayItem(index) {
            if (index < 0 || index >= currentItems.length) return;

            currentIndex = index;
            const item = currentItems[index];
            const display = document.getElementById('content-display');

            console.log('üñºÔ∏è Displaying item', index + 1, '/', currentItems.length, item.type);

            // Show/hide video controls based on content type
            const playPauseBtn = document.getElementById('play-pause-btn');
            const skipBackBtn = document.getElementById('skip-back-btn');
            const skipForwardBtn = document.getElementById('skip-forward-btn');

            if (item.type === 'image') {
                // Hide video-specific controls (play/pause/skip)
                if (playPauseBtn) playPauseBtn.classList.add('hidden');
                if (skipBackBtn) skipBackBtn.classList.add('hidden');
                if (skipForwardBtn) skipForwardBtn.classList.add('hidden');

                // Keep control bar visible for navigation arrows and page counter
                if (controlBar) controlBar.classList.remove('hide-for-images');

                // Remove video-mode class (hides transparent interaction layer)
                document.getElementById('viewer-container').classList.remove('video-mode');

                // Remove video-paused class (hides thumbnail blocker)
                document.getElementById('viewer-container').classList.remove('video-paused');

                // Display image (clean, simple)
                const imageUrl = item.image_url;
                // Use proxy if it's a Drive URL
                const proxiedUrl = imageUrl.includes('drive.google.com')
                    ? `https://creator.recursive.eco/api/proxy-image?url=${encodeURIComponent(imageUrl)}`
                    : imageUrl;

                display.innerHTML = `
                    <img
                        src="${proxiedUrl}"
                        alt="${item.alt_text || 'Content image'}"
                        class="content-item mx-auto"
                        loading="lazy"
                    />
                    ${item.narration ? `<div class="mt-4 text-center text-gray-700 text-lg">${item.narration}</div>` : ''}
                `;
            } else if (item.type === 'video') {
                // Show video controls for videos
                if (playPauseBtn) playPauseBtn.classList.remove('hidden');
                if (skipBackBtn) skipBackBtn.classList.remove('hidden');
                if (skipForwardBtn) skipForwardBtn.classList.remove('hidden');

                // Show control bar in fullscreen for videos
                if (controlBar) controlBar.classList.remove('hide-for-images');

                // Add video-mode class (shows transparent interaction layer)
                document.getElementById('viewer-container').classList.add('video-mode');

                // Display video (YouTube with Player API for end-screen control)
                const videoId = item.video_id;

                // Destroy existing player if any
                if (youtubePlayer) {
                    youtubePlayer.destroy();
                    youtubePlayer = null;
                }

                // Reset video ended state
                videoEnded = false;
                isPlaying = false;

                // Hide persistent overlay when changing videos
                const persistentOverlay = document.getElementById('video-end-overlay');
                if (persistentOverlay) {
                    persistentOverlay.style.display = 'none';
                }

                display.innerHTML = `
                    <div style="position: relative; width: 100%; margin: 0 auto;">
                        <div id="youtube-player-${videoId}" style="width: 100%; aspect-ratio: 16/9;"></div>

                        <!-- Transparent clickable layer to show source (covers 100% including YouTube logo) -->
                        <div id="video-source-layer" onclick="showSourcePopup('${item.url || `https://youtube.com/watch?v=${videoId}`}')" style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: transparent;
                            z-index: 10;
                            cursor: pointer;
                        " title="Click to see video source"></div>

                        ${item.title ? `<div class="mt-4 text-center text-gray-700 text-lg font-semibold">${item.title}</div>` : ''}
                    </div>
                `;

                // Wait for YouTube API to be ready, then create player
                const initPlayer = () => {
                    if (youtubeApiReady && window.YT && window.YT.Player) {
                        try {
                            youtubePlayer = new window.YT.Player(`youtube-player-${videoId}`, {
                                videoId: videoId,
                                playerVars: {
                                    rel: 0,
                                    modestbranding: 1,
                                    enablejsapi: 1,
                                    controls: 0,        // Hide all YouTube controls
                                    fs: 0,              // Disable YouTube fullscreen
                                    iv_load_policy: 3,  // Hide annotations
                                    disablekb: 1        // Disable keyboard controls (prevents conflicts with our nav)
                                },
                                events: {
                                    onStateChange: (event) => {
                                        // Get play/pause icons
                                        const playIcon = document.getElementById('play-icon');
                                        const pauseIcon = document.getElementById('pause-icon');

                                        // -1 = unstarted, 0 = ended, 1 = playing, 2 = paused
                                        if (event.data === 0) {
                                            console.log('Video ended, showing overlay');
                                            videoEnded = true;
                                            isPlaying = false;

                                            // Hide thumbnail blocker (video ended)
                                            document.getElementById('viewer-container').classList.remove('video-paused');

                                            // Show play icon
                                            if (playIcon) playIcon.style.display = '';
                                            if (pauseIcon) pauseIcon.style.display = 'none';

                                            // Update persistent overlay title
                                            const overlayTitle = document.getElementById('overlay-title');
                                            if (overlayTitle) {
                                                overlayTitle.textContent = item.title || 'Video Complete';
                                            }

                                            // Show persistent overlay
                                            const overlay = document.getElementById('video-end-overlay');
                                            if (overlay) {
                                                overlay.style.display = 'flex';
                                            }
                                        } else if (event.data === 1) {
                                            // Playing - show pause icon
                                            isPlaying = true;
                                            // Hide thumbnail blocker (video playing)
                                            document.getElementById('viewer-container').classList.remove('video-paused');
                                            if (playIcon) playIcon.style.display = 'none';
                                            if (pauseIcon) pauseIcon.style.display = '';
                                        } else if (event.data === 2) {
                                            // Paused - show play icon and thumbnail blocker
                                            isPlaying = false;
                                            // Show thumbnail blocker (video paused)
                                            document.getElementById('viewer-container').classList.add('video-paused');
                                            if (playIcon) playIcon.style.display = '';
                                            if (pauseIcon) pauseIcon.style.display = 'none';
                                        }
                                    }
                                }
                            });

                        } catch (error) {
                            console.error('Error creating YouTube player:', error);
                        }
                    } else {
                        // API not ready yet, try again in 100ms
                        setTimeout(initPlayer, 100);
                    }
                };

                // Start player initialization
                setTimeout(initPlayer, 100);
            }

            // Update page indicator
            document.getElementById('current-page').textContent = index + 1;

            // Update button states
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === currentItems.length - 1;
        }

        // Show error state
        function showError() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('content-wrapper').classList.add('hidden');
        }

        // Navigation functions
        function goToNext() {
            if (currentIndex < currentItems.length - 1) {
                displayItem(currentIndex + 1);
            }
        }

        function goToPrevious() {
            const currentItem = currentItems[currentIndex];

            // Smart behavior for videos: restart if more than 3 seconds in
            if (currentItem.type === 'video' && youtubePlayer) {
                const currentTime = youtubePlayer.getCurrentTime ? youtubePlayer.getCurrentTime() : 0;

                if (currentTime > 3) {
                    // Restart current video
                    youtubePlayer.seekTo(0);
                    youtubePlayer.playVideo();
                    console.log('‚èÆÔ∏è Restarting video from beginning');
                    return;
                }
            }

            // Go to actual previous item (for images or videos at start)
            if (currentIndex > 0) {
                displayItem(currentIndex - 1);
            }
        }

        // Fullscreen toggle
        async function toggleFullscreen() {
            const container = document.getElementById('viewer-container');
            if (!document.fullscreenElement) {
                await container.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        }

        // Event listeners
        document.getElementById('next-btn').addEventListener('click', goToNext);
        document.getElementById('prev-btn').addEventListener('click', goToPrevious);
        document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

        // Transparent interaction layer - click to toggle play/pause
        document.getElementById('video-interaction-layer').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getPlayerState) {
                const state = youtubePlayer.getPlayerState();
                if (state === 1) {
                    // Playing ‚Üí pause
                    youtubePlayer.pauseVideo();
                } else if (state === -1 || state === 2 || state === 5) {
                    // Unstarted, paused, or cued ‚Üí play
                    youtubePlayer.playVideo();
                }
            }
        });

        // Play/Pause button for YouTube videos
        document.getElementById('play-pause-btn').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getPlayerState) {
                const state = youtubePlayer.getPlayerState();
                if (state === 1) {
                    // Playing ‚Üí pause
                    youtubePlayer.pauseVideo();
                } else {
                    // Paused or other ‚Üí play
                    youtubePlayer.playVideo();
                }
            }
        });

        // Skip backward 10 seconds
        document.getElementById('skip-back-btn').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getCurrentTime) {
                const currentTime = youtubePlayer.getCurrentTime();
                youtubePlayer.seekTo(Math.max(0, currentTime - 10), true);
            }
        });

        // Skip forward 10 seconds
        document.getElementById('skip-forward-btn').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getCurrentTime && youtubePlayer.getDuration) {
                const currentTime = youtubePlayer.getCurrentTime();
                const duration = youtubePlayer.getDuration();
                youtubePlayer.seekTo(Math.min(duration, currentTime + 10), true);
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') goToNext();
            if (e.key === 'ArrowLeft') goToPrevious();
            if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
            // Spacebar for play/pause
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault(); // Prevent page scroll
                if (youtubePlayer && youtubePlayer.getPlayerState) {
                    const state = youtubePlayer.getPlayerState();
                    if (state === 1) {
                        youtubePlayer.pauseVideo();
                    } else {
                        youtubePlayer.playVideo();
                    }
                }
            }
            // J = Skip back 10 seconds (like YouTube)
            if (e.key === 'j' || e.key === 'J') {
                if (youtubePlayer && youtubePlayer.getCurrentTime) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    youtubePlayer.seekTo(Math.max(0, currentTime - 10), true);
                }
            }
            // L = Skip forward 10 seconds (like YouTube)
            if (e.key === 'l' || e.key === 'L') {
                if (youtubePlayer && youtubePlayer.getCurrentTime && youtubePlayer.getDuration) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    const duration = youtubePlayer.getDuration();
                    youtubePlayer.seekTo(Math.min(duration, currentTime + 10), true);
                }
            }
        });

        // Touch/swipe support
        let touchStartX = null;
        let touchEndX = null;
        const minSwipeDistance = 50;

        document.getElementById('content-display').addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.getElementById('content-display').addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (!touchStartX || !touchEndX) return;

            const distance = touchStartX - touchEndX;
            const isLeftSwipe = distance > minSwipeDistance;
            const isRightSwipe = distance < -minSwipeDistance;

            if (isLeftSwipe) {
                goToNext();
            } else if (isRightSwipe) {
                goToPrevious();
            }

            touchStartX = null;
            touchEndX = null;
        }

        // Mouse click navigation for fullscreen (desktop)
        document.getElementById('content-display').addEventListener('click', (e) => {
            // Only work in fullscreen mode
            if (!document.fullscreenElement) return;

            // Don't interfere with touch events
            if (e.pointerType === 'touch') return;

            const clickX = e.clientX;
            const screenWidth = window.innerWidth;

            // Left 40% = previous, Right 60% = next
            if (clickX < screenWidth * 0.4) {
                goToPrevious();
            } else {
                goToNext();
            }
        });

        // Setup persistent overlay button listeners (attach once at page load)
        const replayBtnPersistent = document.getElementById('replay-btn-persistent');
        const nextBtnPersistent = document.getElementById('next-btn-persistent');

        if (replayBtnPersistent) {
            replayBtnPersistent.addEventListener('click', () => {
                console.log('Replay clicked');
                if (youtubePlayer) {
                    youtubePlayer.seekTo(0);
                    youtubePlayer.playVideo();
                    videoEnded = false;

                    // Hide overlay
                    const overlay = document.getElementById('video-end-overlay');
                    if (overlay) overlay.style.display = 'none';
                }
            });
        }

        if (nextBtnPersistent) {
            nextBtnPersistent.addEventListener('click', () => {
                console.log('Next clicked');
                videoEnded = false;

                // Hide overlay
                const overlay = document.getElementById('video-end-overlay');
                if (overlay) overlay.style.display = 'none';

                // Navigate
                if (currentIndex < currentItems.length - 1) {
                    goToNext();
                } else {
                    displayItem(0); // Loop to start
                }
            });
        }

        // Auto-hide controls in fullscreen after 3 seconds of inactivity
        let hideControlsTimeout;
        const controlBar = document.getElementById('video-controls-bar');

        function showControls() {
            if (document.fullscreenElement && controlBar) {
                controlBar.classList.remove('hidden-controls');
                clearTimeout(hideControlsTimeout);
                hideControlsTimeout = setTimeout(() => {
                    controlBar.classList.add('hidden-controls');
                }, 3000); // Hide after 3 seconds of inactivity
            }
        }

        // Show controls on mouse move, click, or mouse enter in fullscreen
        document.addEventListener('mousemove', showControls);
        document.addEventListener('click', showControls);

        // Also show on mouse entering the viewer container
        const viewerContainer = document.getElementById('viewer-container');
        if (viewerContainer) {
            viewerContainer.addEventListener('mouseenter', showControls);
        }

        // Handle fullscreen state changes
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement && controlBar) {
                showControls(); // Show controls when entering fullscreen
            } else if (controlBar) {
                controlBar.classList.remove('hidden-controls'); // Always show when not in fullscreen
            }
        });

        // ICS Calendar Generation Utility
        function generateICS(title, description, startDate, durationMinutes, url) {
            const start = new Date(startDate);
            const end = new Date(start.getTime() + durationMinutes * 60000);

            // Format dates as YYYYMMDDTHHMMSSZ (UTC)
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Recursive.Eco//Family Art Ritual//EN
BEGIN:VEVENT
UID:${Date.now()}-${Math.random().toString(36).substring(2)}@recursive.eco
DTSTAMP:${formatDate(new Date())}
DTSTART:${formatDate(start)}
DTEND:${formatDate(end)}
SUMMARY:${title}
DESCRIPTION:${description}\\n\\nLink: ${url}
URL:${url}
END:VEVENT
END:VCALENDAR`;

            return icsContent;
        }

        function downloadICS(icsContent, filename) {
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        }

        // Calendar Button - Show Modal
        document.getElementById('calendar-btn').addEventListener('click', () => {
            const modal = document.getElementById('calendar-modal');
            modal.style.display = 'flex';

            // Set default to tomorrow at 10am
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(10, 0, 0, 0);

            const dateInput = document.getElementById('ritual-datetime');
            dateInput.value = tomorrow.toISOString().slice(0, 16);
        });

        // Calendar Cancel Button
        document.getElementById('calendar-cancel').addEventListener('click', () => {
            document.getElementById('calendar-modal').style.display = 'none';
        });

        // Calendar Download .ics Button
        document.getElementById('calendar-download-ics').addEventListener('click', () => {
            const datetime = document.getElementById('ritual-datetime').value;

            if (!datetime) {
                alert('Please select a date and time');
                return;
            }

            const startDate = new Date(datetime);
            const title = `Family Art Ritual ‚Äì ${currentContent.title || 'Playlist'}`;
            const description = currentContent.description || 'Watch the calm playlist, explore the content, and enjoy this ritual together.';
            const pageUrl = window.location.href;
            const durationMinutes = 30; // Default 30 min

            const icsContent = generateICS(title, description, startDate, durationMinutes, pageUrl);
            const filename = `family-ritual-${(currentContent.title || 'playlist').toLowerCase().replace(/[^a-z0-9]+/g, '-')}.ics`;

            downloadICS(icsContent, filename);

            document.getElementById('calendar-modal').style.display = 'none';

            alert('‚úÖ Calendar invite downloaded! You can now add it to your calendar app.');
            console.log('‚úÖ Calendar invite generated for:', startDate);
        });

        // Calendar Add to Google Calendar Button
        document.getElementById('calendar-add-google').addEventListener('click', () => {
            const datetime = document.getElementById('ritual-datetime').value;

            if (!datetime) {
                alert('Please select a date and time');
                return;
            }

            const startDate = new Date(datetime);
            const endDate = new Date(startDate.getTime() + 30 * 60000); // 30 minutes later

            // Format dates for Google Calendar (YYYYMMDDTHHmmssZ)
            const formatGoogleDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            };

            const title = encodeURIComponent(`Family Art Ritual ‚Äì ${currentContent.title || 'Playlist'}`);
            const description = encodeURIComponent(
                (currentContent.description || 'Watch the calm playlist, explore the content, and enjoy this ritual together.') +
                '\n\nWatch at: ' + window.location.href
            );
            const startTime = formatGoogleDate(startDate);
            const endTime = formatGoogleDate(endDate);

            // Build Google Calendar URL
            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startTime}/${endTime}&details=${description}`;

            // Open in new tab
            window.open(googleCalendarUrl, '_blank');

            document.getElementById('calendar-modal').style.display = 'none';

            console.log('üìÖ Opened Google Calendar with event:', startDate);
        });

        // Report Button - Show Modal
        document.getElementById('report-btn').addEventListener('click', () => {
            const modal = document.getElementById('report-modal');
            modal.style.display = 'flex';

            // Reset error message
            document.getElementById('report-error').style.display = 'none';
        });

        // Report Modal - Close Button
        document.getElementById('report-modal-close').addEventListener('click', () => {
            document.getElementById('report-modal').style.display = 'none';
        });

        // Report Modal - Cancel Button
        document.getElementById('report-cancel').addEventListener('click', () => {
            document.getElementById('report-modal').style.display = 'none';
        });

        // Report Modal - Submit Report (Direct Supabase Update)
        document.getElementById('report-submit').addEventListener('click', async () => {
            const errorDiv = document.getElementById('report-error');
            const errorText = errorDiv.querySelector('p');

            // Hide error
            errorDiv.style.display = 'none';

            // Disable submit button
            const submitBtn = document.getElementById('report-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Reporting...';
            submitBtn.style.opacity = '0.6';

            try {
                console.log('üìù Reporting content:', contentId);

                // First, fetch the current document to get the full document_data
                const { data: currentDoc, error: fetchError } = await supabaseClient
                    .from('user_documents')
                    .select('document_data, reported')
                    .eq('id', contentId)
                    .single();

                if (fetchError) {
                    console.error('‚ùå Fetch error:', fetchError);
                    throw new Error(fetchError.message || 'Failed to fetch current content');
                }

                console.log('üì¶ Current document:', currentDoc);
                console.log('üì¶ Current is_published value:', currentDoc.document_data.is_published);
                console.log('üì¶ Current is_published type:', typeof currentDoc.document_data.is_published);

                // Update the is_published field within document_data
                // Now using boolean for consistency
                const updatedDocumentData = {
                    ...currentDoc.document_data,
                    is_published: false  // Boolean false
                };

                console.log('üìù Updated is_published value:', updatedDocumentData.is_published);
                console.log('üìù Updated is_published type:', typeof updatedDocumentData.is_published);
                console.log('üìù Is boolean false?:', updatedDocumentData.is_published === false);

                // Update Supabase - mark as reported ONLY (test without document_data)
                const { data: updateResult, error: updateError } = await supabaseClient
                    .from('user_documents')
                    .update({
                        reported: true
                        // NOT updating document_data to test if that's the issue
                    })
                    .eq('id', contentId)
                    .select();

                console.log('üìä Update result:', updateResult);
                console.log('üìä Update error:', updateError);

                if (updateError) {
                    console.error('‚ùå Update error details:', updateError);
                    throw new Error(updateError.message || 'Failed to update content');
                }

                if (!updateResult || updateResult.length === 0) {
                    console.error('‚ùå No rows were updated');
                    throw new Error('Update succeeded but no rows were affected. Check RLS policies.');
                }

                console.log('‚úÖ Content reported and unpublished');

                // Close modal
                document.getElementById('report-modal').style.display = 'none';

                // Show success popup
                alert('Content reported and unpublished successfully. The page will now reload.');

                // Reload the page - it will naturally show error since content is unpublished
                window.location.reload();

            } catch (error) {
                console.error('‚ùå Report error:', error);
                errorText.textContent = error.message || 'Failed to submit report. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Report & Unpublish';
                submitBtn.style.opacity = '1';
            }
        });

        // Source Popup Functions
        function showSourcePopup(url) {
            const popup = document.getElementById('source-popup');
            const urlDisplay = document.getElementById('source-url-display');

            if (urlDisplay) {
                urlDisplay.textContent = url || 'Unknown source';
            }

            if (popup) {
                popup.style.display = 'flex';
            }

            console.log('üì∫ Showing source popup for:', url);
        }

        function closeSourcePopup(event) {
            if (event) {
                event.stopPropagation();
            }

            const popup = document.getElementById('source-popup');
            if (popup) {
                popup.style.display = 'none';
            }

            console.log('‚úï Source popup closed');
        }

        // CSV Export Functionality
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if (!currentItems || currentItems.length === 0) {
                alert('No content loaded to export. Please wait for the content to load first.');
                return;
            }

            // Create CSV header
            let csv = 'Position,Title,Type,Link\n';

            // Add each item
            currentItems.forEach((item, index) => {
                const title = (item.title || `Item ${index + 1}`).replace(/"/g, '""'); // Escape quotes
                const type = item.type;
                let link = '';

                if (type === 'video') {
                    if (item.url) {
                        link = item.url;
                    } else if (item.video_id) {
                        // YouTube (11 characters) or Google Drive (longer)
                        if (item.video_id.length === 11) {
                            link = `https://youtube.com/watch?v=${item.video_id}`;
                        } else {
                            // Google Drive
                            link = `https://drive.google.com/file/d/${item.video_id}/view`;
                        }
                    }
                } else if (type === 'image') {
                    link = item.image_url || '';
                }

                csv += `${index + 1},"${title}",${type},"${link}"\n`;
            });

            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = url;

            // Generate filename from content title
            const filename = `${(currentContent.title || 'playlist').toLowerCase().replace(/[^a-z0-9]+/g, '-')}-program.csv`;
            downloadLink.download = filename;

            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);

            console.log('‚úÖ CSV exported:', currentItems.length, 'items');
        });

        // Initialize on page load
        loadContent();
    </script>
</body>
</html>
