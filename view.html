<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">View Content - Recursive.eco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <style>
        .content-item {
            max-height: 80vh;
            object-fit: contain;
        }
        .video-embed {
            width: 100%;
            aspect-ratio: 16/9;
            max-height: 60vh;
            border: none;
        }

        /* YouTube end-screen overlay */
        .video-overlay {
            position: absolute;
            inset: 0;
            background: rgb(0, 0, 0);
            border-radius: 0.5rem;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            z-index: 10;
        }
        .video-overlay.active {
            display: flex;
        }
        .video-overlay-button {
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
            min-width: 160px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        .video-overlay-button:hover {
            transform: scale(1.05);
        }
        @media (max-width: 640px) {
            .video-overlay-buttons {
                flex-direction: column;
                width: 100%;
                padding: 0 1rem;
            }
            .video-overlay-button {
                width: 100%;
            }
        }
        .content-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }
        #content-display {
            width: 100%;
            max-width: 100%;
        }

        /* Fullscreen styles */
        #viewer-container:fullscreen {
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #viewer-container:fullscreen .content-item {
            max-height: 100vh;
            max-width: 100vw;
        }

        #viewer-container:fullscreen .page-indicator {
            opacity: 0;
            pointer-events: none;
        }

        #viewer-container:fullscreen #content-wrapper > div:first-child {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #viewer-container:fullscreen .flex.items-center.justify-between {
            display: none;
        }

        /* Fullscreen YouTube player sizing */
        #viewer-container:fullscreen #content-display > div {
            width: 100vw !important;
            max-width: 100vw !important;
            height: 100vh !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #viewer-container:fullscreen #content-display > div > div[id^="youtube-player-"] {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }

        #viewer-container:fullscreen #video-end-overlay {
            width: 100vw !important;
            height: 100vh !important;
        }

        .page-indicator {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Load inline component system -->
    <script src="/assets/js/components/site-shell-inline.js"></script>

    <!-- Header Component -->
    <site-header></site-header>

    <!-- Hero Section -->
    <div id="hero-section" class="bg-gradient-to-br from-purple-50 to-pink-100 py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 id="content-title" class="text-4xl font-bold text-gray-900 mb-3">Loading...</h1>
            <p id="content-description" class="text-xl text-gray-600 mb-2"></p>
        </div>
    </div>

    <!-- Content Viewer -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="viewer-container" class="relative bg-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Loading State -->
            <div id="loading-state" class="flex items-center justify-center h-96">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading content...</p>
                </div>
            </div>

            <!-- Error State (404) -->
            <div id="error-state" class="hidden flex items-center justify-center h-96">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Content Not Found</h2>
                    <p class="text-gray-600 mb-6">This content doesn't exist or hasn't been published yet.</p>
                    <a href="/" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Return Home
                    </a>
                </div>
            </div>

            <!-- Content Display -->
            <div id="content-wrapper" class="hidden">
                <div class="relative content-container">
                    <div id="content-display" class="w-full"></div>

                    <!-- Page Indicator -->
                    <div class="page-indicator">
                        <span id="current-page">1</span> / <span id="total-pages">1</span>
                    </div>

                    <!-- Persistent Video End Overlay -->
                    <div id="video-end-overlay" class="video-overlay" style="display: none; z-index: 9999;">
                        <div style="text-align: center;">
                            <h3 id="overlay-title" style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 8px;">
                                Video Complete
                            </h3>
                            <p style="color: #d1d5db;">What would you like to do next?</p>
                        </div>

                        <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                            <button id="replay-btn-persistent" class="video-overlay-button" style="background: #9333ea; color: white;">
                                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Replay
                            </button>

                            <button id="next-btn-persistent" class="video-overlay-button" style="background: #2563eb; color: white;">
                                Next
                                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Navigation Controls -->
                <div class="flex items-center justify-center gap-3 p-4 border-t flex-wrap">
                    <button id="prev-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        ‚Üê Previous
                    </button>

                    <!-- Video Controls (Show only for videos) -->
                    <button id="skip-back-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors hidden" title="Skip back 10 seconds">
                        ‚è™ 10s
                    </button>

                    <button id="play-pause-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors hidden">
                        <span id="play-icon">‚ñ∂ Play</span>
                        <span id="pause-icon" style="display: none;">‚è∏ Pause</span>
                    </button>

                    <button id="skip-forward-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors hidden" title="Skip forward 10 seconds">
                        10s ‚è©
                    </button>

                    <button id="fullscreen-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        ‚õ∂ Fullscreen
                    </button>
                    <button id="next-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Component -->
    <site-footer></site-footer>

    <script>
        // Initialize Supabase client
        const { createClient } = window.supabase;
        const supabaseClient = createClient(
            'https://evixjvagwjmjdjpbazuj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aXhqdmFnd2ptamRqcGJhenVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3Mjc5NDIsImV4cCI6MjA2OTMwMzk0Mn0.d7rp6xs9KswI7mGnw7V5XTARiJD4L9pAcEooI0zZg0E'
        );

        let currentContent = null;
        let currentItems = [];
        let currentIndex = 0;
        let youtubePlayer = null;
        let videoEnded = false;
        let youtubeApiReady = false;
        let isPlaying = false;

        // Load YouTube IFrame API dynamically
        console.log('üì∫ Loading YouTube IFrame API...');
        window.onYouTubeIframeAPIReady = function() {
            console.log('‚úÖ YouTube IFrame API ready!');
            youtubeApiReady = true;
        };

        // Dynamically inject YouTube API script
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Get content ID from URL (supports both /view/ID and /view.html?id=ID)
        const urlParams = new URLSearchParams(window.location.search);
        let contentId = urlParams.get('id');

        // If no query param, try to extract from pathname (e.g., /view/abc-123)
        if (!contentId) {
            const pathParts = window.location.pathname.split('/');
            // Check if URL is like /view/some-uuid
            if (pathParts[1] === 'view' && pathParts[2]) {
                contentId = pathParts[2];
            }
        }

        // Debug logging
        console.log('üîç Full URL:', window.location.href);
        console.log('üîç Pathname:', window.location.pathname);
        console.log('üîç Search params:', window.location.search);
        console.log('üîç Extracted Content ID:', contentId);

        // Load content from Supabase
        async function loadContent() {
            try {
                if (!contentId) {
                    throw new Error('No content ID provided');
                }

                console.log('üîç Fetching content:', contentId);

                const { data, error } = await supabaseClient
                    .from('user_documents')
                    .select('*')
                    .eq('id', contentId)
                    .eq('tool_slug', 'sequence') // Only sequences
                    .single();

                if (error) {
                    console.error('‚ùå Supabase error:', error);
                    throw error;
                }

                if (!data) {
                    throw new Error('Content not found');
                }

                console.log('üì¶ Fetched data:', data);

                // CRITICAL: Check if published
                const isPublished = data.document_data?.is_published === 'true';
                console.log('üîì Is published?', isPublished);

                if (!isPublished) {
                    console.warn('‚ö†Ô∏è Content not published');
                    throw new Error('Content not published');
                }

                // Map Supabase data to viewer structure
                currentContent = {
                    title: data.document_data.title || 'Untitled',
                    description: data.document_data.description || '',
                    items: data.document_data.items || []
                };

                if (currentContent.items.length === 0) {
                    throw new Error('Content has no items');
                }

                currentItems = currentContent.items;
                console.log('‚úÖ Loaded', currentItems.length, 'items');

                // Update page metadata
                document.getElementById('page-title').textContent = `${currentContent.title} - Recursive.eco`;
                document.getElementById('content-title').textContent = currentContent.title;
                document.getElementById('content-description').textContent = currentContent.description;
                document.getElementById('total-pages').textContent = currentItems.length;

                // Hide loading, show content
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('content-wrapper').classList.remove('hidden');

                // Display first item
                displayItem(0);

            } catch (err) {
                console.error('‚ùå Error loading content:', err);
                showError();
            }
        }

        // Display item at index
        function displayItem(index) {
            if (index < 0 || index >= currentItems.length) return;

            currentIndex = index;
            const item = currentItems[index];
            const display = document.getElementById('content-display');

            console.log('üñºÔ∏è Displaying item', index + 1, '/', currentItems.length, item.type);

            // Show/hide video controls based on content type
            const playPauseBtn = document.getElementById('play-pause-btn');
            const skipBackBtn = document.getElementById('skip-back-btn');
            const skipForwardBtn = document.getElementById('skip-forward-btn');

            if (item.type === 'image') {
                // Hide video controls for images
                if (playPauseBtn) playPauseBtn.classList.add('hidden');
                if (skipBackBtn) skipBackBtn.classList.add('hidden');
                if (skipForwardBtn) skipForwardBtn.classList.add('hidden');

                // Display image
                const imageUrl = item.image_url;
                // Use proxy if it's a Drive URL
                const proxiedUrl = imageUrl.includes('drive.google.com')
                    ? `https://creator.recursive.eco/api/proxy-image?url=${encodeURIComponent(imageUrl)}`
                    : imageUrl;

                display.innerHTML = `
                    <img
                        src="${proxiedUrl}"
                        alt="${item.alt_text || 'Content image'}"
                        class="content-item mx-auto"
                        loading="lazy"
                    />
                    ${item.narration ? `<div class="mt-4 text-center text-gray-700 text-lg">${item.narration}</div>` : ''}
                `;
            } else if (item.type === 'video') {
                // Show video controls for videos
                if (playPauseBtn) playPauseBtn.classList.remove('hidden');
                if (skipBackBtn) skipBackBtn.classList.remove('hidden');
                if (skipForwardBtn) skipForwardBtn.classList.remove('hidden');
                // Display video (YouTube with Player API for end-screen control)
                const videoId = item.video_id;

                // Destroy existing player if any
                if (youtubePlayer) {
                    youtubePlayer.destroy();
                    youtubePlayer = null;
                }

                // Reset video ended state
                videoEnded = false;
                isPlaying = false;

                // Hide persistent overlay when changing videos
                const persistentOverlay = document.getElementById('video-end-overlay');
                if (persistentOverlay) {
                    persistentOverlay.style.display = 'none';
                }

                display.innerHTML = `
                    <div style="position: relative; width: 100%; max-width: 900px; margin: 0 auto;">
                        <div id="youtube-player-${videoId}" style="width: 100%; aspect-ratio: 16/9;"></div>
                        ${item.title ? `<div class="mt-4 text-center text-gray-700 text-lg font-semibold">${item.title}</div>` : ''}
                    </div>
                `;

                // Wait for YouTube API to be ready, then create player
                const initPlayer = () => {
                    if (youtubeApiReady && window.YT && window.YT.Player) {
                        try {
                            youtubePlayer = new window.YT.Player(`youtube-player-${videoId}`, {
                                videoId: videoId,
                                playerVars: {
                                    rel: 0,
                                    modestbranding: 1,
                                    enablejsapi: 1,
                                    controls: 0,        // Hide all YouTube controls
                                    fs: 0,              // Disable YouTube fullscreen
                                    iv_load_policy: 3   // Hide annotations
                                },
                                events: {
                                    onStateChange: (event) => {
                                        // Get play/pause icons
                                        const playIcon = document.getElementById('play-icon');
                                        const pauseIcon = document.getElementById('pause-icon');

                                        // 0 = ended, 1 = playing, 2 = paused
                                        if (event.data === 0) {
                                            console.log('Video ended, showing overlay');
                                            videoEnded = true;
                                            isPlaying = false;

                                            // Show play icon
                                            if (playIcon) playIcon.style.display = '';
                                            if (pauseIcon) pauseIcon.style.display = 'none';

                                            // Update persistent overlay title
                                            const overlayTitle = document.getElementById('overlay-title');
                                            if (overlayTitle) {
                                                overlayTitle.textContent = item.title || 'Video Complete';
                                            }

                                            // Show persistent overlay
                                            const overlay = document.getElementById('video-end-overlay');
                                            if (overlay) {
                                                overlay.style.display = 'flex';
                                            }
                                        } else if (event.data === 1) {
                                            // Playing - show pause icon
                                            isPlaying = true;
                                            if (playIcon) playIcon.style.display = 'none';
                                            if (pauseIcon) pauseIcon.style.display = '';
                                        } else if (event.data === 2) {
                                            // Paused - show play icon
                                            isPlaying = false;
                                            if (playIcon) playIcon.style.display = '';
                                            if (pauseIcon) pauseIcon.style.display = 'none';
                                        }
                                    }
                                }
                            });

                        } catch (error) {
                            console.error('Error creating YouTube player:', error);
                        }
                    } else {
                        // API not ready yet, try again in 100ms
                        setTimeout(initPlayer, 100);
                    }
                };

                // Start player initialization
                setTimeout(initPlayer, 100);
            }

            // Update page indicator
            document.getElementById('current-page').textContent = index + 1;

            // Update button states
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === currentItems.length - 1;
        }

        // Show error state
        function showError() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('content-wrapper').classList.add('hidden');
        }

        // Navigation functions
        function goToNext() {
            if (currentIndex < currentItems.length - 1) {
                displayItem(currentIndex + 1);
            }
        }

        function goToPrevious() {
            if (currentIndex > 0) {
                displayItem(currentIndex - 1);
            }
        }

        // Fullscreen toggle
        async function toggleFullscreen() {
            const container = document.getElementById('viewer-container');
            if (!document.fullscreenElement) {
                await container.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        }

        // Event listeners
        document.getElementById('next-btn').addEventListener('click', goToNext);
        document.getElementById('prev-btn').addEventListener('click', goToPrevious);
        document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

        // Play/Pause button for YouTube videos
        document.getElementById('play-pause-btn').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getPlayerState) {
                const state = youtubePlayer.getPlayerState();
                if (state === 1) {
                    // Playing ‚Üí pause
                    youtubePlayer.pauseVideo();
                } else {
                    // Paused or other ‚Üí play
                    youtubePlayer.playVideo();
                }
            }
        });

        // Skip backward 10 seconds
        document.getElementById('skip-back-btn').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getCurrentTime) {
                const currentTime = youtubePlayer.getCurrentTime();
                youtubePlayer.seekTo(Math.max(0, currentTime - 10), true);
            }
        });

        // Skip forward 10 seconds
        document.getElementById('skip-forward-btn').addEventListener('click', () => {
            if (youtubePlayer && youtubePlayer.getCurrentTime && youtubePlayer.getDuration) {
                const currentTime = youtubePlayer.getCurrentTime();
                const duration = youtubePlayer.getDuration();
                youtubePlayer.seekTo(Math.min(duration, currentTime + 10), true);
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') goToNext();
            if (e.key === 'ArrowLeft') goToPrevious();
            if (e.key === 'Escape' && document.fullscreenElement) {
                document.exitFullscreen();
            }
            // Spacebar for play/pause
            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault(); // Prevent page scroll
                if (youtubePlayer && youtubePlayer.getPlayerState) {
                    const state = youtubePlayer.getPlayerState();
                    if (state === 1) {
                        youtubePlayer.pauseVideo();
                    } else {
                        youtubePlayer.playVideo();
                    }
                }
            }
            // J = Skip back 10 seconds (like YouTube)
            if (e.key === 'j' || e.key === 'J') {
                if (youtubePlayer && youtubePlayer.getCurrentTime) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    youtubePlayer.seekTo(Math.max(0, currentTime - 10), true);
                }
            }
            // L = Skip forward 10 seconds (like YouTube)
            if (e.key === 'l' || e.key === 'L') {
                if (youtubePlayer && youtubePlayer.getCurrentTime && youtubePlayer.getDuration) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    const duration = youtubePlayer.getDuration();
                    youtubePlayer.seekTo(Math.min(duration, currentTime + 10), true);
                }
            }
        });

        // Touch/swipe support
        let touchStartX = null;
        let touchEndX = null;
        const minSwipeDistance = 50;

        document.getElementById('content-display').addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.getElementById('content-display').addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (!touchStartX || !touchEndX) return;

            const distance = touchStartX - touchEndX;
            const isLeftSwipe = distance > minSwipeDistance;
            const isRightSwipe = distance < -minSwipeDistance;

            if (isLeftSwipe) {
                goToNext();
            } else if (isRightSwipe) {
                goToPrevious();
            }

            touchStartX = null;
            touchEndX = null;
        }

        // Mouse click navigation for fullscreen (desktop)
        document.getElementById('content-display').addEventListener('click', (e) => {
            // Only work in fullscreen mode
            if (!document.fullscreenElement) return;

            // Don't interfere with touch events
            if (e.pointerType === 'touch') return;

            const clickX = e.clientX;
            const screenWidth = window.innerWidth;

            // Left 40% = previous, Right 60% = next
            if (clickX < screenWidth * 0.4) {
                goToPrevious();
            } else {
                goToNext();
            }
        });

        // Setup persistent overlay button listeners (attach once at page load)
        const replayBtnPersistent = document.getElementById('replay-btn-persistent');
        const nextBtnPersistent = document.getElementById('next-btn-persistent');

        if (replayBtnPersistent) {
            replayBtnPersistent.addEventListener('click', () => {
                console.log('Replay clicked');
                if (youtubePlayer) {
                    youtubePlayer.seekTo(0);
                    youtubePlayer.playVideo();
                    videoEnded = false;

                    // Hide overlay
                    const overlay = document.getElementById('video-end-overlay');
                    if (overlay) overlay.style.display = 'none';
                }
            });
        }

        if (nextBtnPersistent) {
            nextBtnPersistent.addEventListener('click', () => {
                console.log('Next clicked');
                videoEnded = false;

                // Hide overlay
                const overlay = document.getElementById('video-end-overlay');
                if (overlay) overlay.style.display = 'none';

                // Navigate
                if (currentIndex < currentItems.length - 1) {
                    goToNext();
                } else {
                    displayItem(0); // Loop to start
                }
            });
        }

        // Initialize on page load
        loadContent();
    </script>
</body>
</html>
